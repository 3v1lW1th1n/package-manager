#! /usr/bin/env bash

cp -R $PACKAGES .

for p in packages/*; do
    ( cd $p && git init && git add * && git commit -m 'init' )
done

cp -R $SOURCES .

find sources -name 'zkg.index' -exec sed -i -e "s#^#$(pwd)/packages/#" {} \;

for s in sources/*; do
    ( cd $s && git init && git add * && git commit -m 'init' )
done

# Create a branch in source "one", drop corge, move back to master
git -C ./sources/one checkout -b drop-corge
sed -i '/corge/d' ./sources/one/bob/zkg.index
git -C ./sources/one add ./bob/zkg.index
git -C ./sources/one commit -m 'Remove corge'
git -C ./sources/one checkout master

echo "\
[sources]
one = $(pwd)/sources/one
[paths]
state_dir = $(pwd)/state
script_dir = $(pwd)/scripts
plugin_dir = $(pwd)/plugins
" >> config

type zeek-config > /dev/null 2>&1 && echo "zeek_dist = $(zeek-config --zeek_dist)" >> config || true
